---
title: "Group_project"
author: "Jo"
date: "October 28, 2019"
output: html_document
---

read in data add in treatment numbers
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("fix_chl.R")
source("Graphing_Set_Up.R")
library(lme4)
library(coefplot)
library(nlme)
library(tidyquant)

```


Remove treatments with ceriodaphnia since they didn't survive
```{r}
dat <- newdat %>% filter(treatment != 5 & treatment != 6 & treatment != 9 & treatment != 10 & treatment != 13 & treatment != 14 )
## consider (! treatment %in% c(5,6,9,10,13,14))

```

make a columns for disturbed/undistrubed and both/none/cladoceran/snail

```{r}

dat$disturb <- "X"
  
for (i in 1:nrow(dat)){
  if (dat$treatment[i] ==2| dat$treatment[i] ==4| dat$treatment[i] ==8|
      dat$treatment[i] ==12){
    dat$disturb[i] <- "y"
  } else if (dat$treatment[i] ==1|dat$treatment[i] ==3|dat$treatment[i] ==7|dat$treatment[i] ==11){
    dat$disturb[i] <- "n"
  }}

dat$animal <- "X"

for (i in 1:nrow(dat)){
  if (dat$treatment[i] ==3| dat$treatment[i] ==4){
    dat$animal[i] <- "daphnia"
  } else if (dat$treatment[i] ==7|dat$treatment[i] ==8){
    dat$animal[i] <- "snail"
  } else if (dat$treatment[i] ==11|dat$treatment[i] ==12){
    dat$animal[i] <- "both"}
  else if (dat$treatment[i] ==1|dat$treatment[i] ==2){
    dat$animal[i] <- "none"}
}





```




Subset final time point for Nh4 and final 4 days for Chl
```{r final time point}
fday <- dat %>% filter(ExptDay == 40)
l <- as.numeric(unique(fday$TankNum))
fday1 <- dat %>% filter(ExptDay == 39) %>% filter(TankNum !=20 & TankNum !=21 & TankNum !=22 & TankNum != 23 &
                                                  TankNum !=24 & TankNum !=25 & TankNum !=26 & TankNum != 27 & 
                                                  TankNum !=28 & TankNum !=29 & TankNum !=30 & TankNum != 31 & 
                                                  TankNum !=32 & TankNum !=33 & TankNum !=34 & TankNum != 35 & 
                                                  TankNum !=36 & TankNum !=37 & TankNum !=38 & TankNum != 39 & 
                                                  TankNum !=40 & TankNum !=83 & TankNum !=84 & TankNum != 85 & 
                                                  TankNum !=86 & TankNum !=87 & TankNum !=88 & TankNum != 89 & 
                                                  TankNum !=90 & TankNum !=91 & TankNum !=92 & TankNum != 93 &
                                                  TankNum !=94 & TankNum !=95 & TankNum !=96 & TankNum != 97 & 
                                                  TankNum !=98 & TankNum !=99 & TankNum !=100& TankNum != 101 & 
                                                  TankNum != 102 & TankNum != 103 & TankNum != 104 & TankNum != 105 & 
                                                  TankNum != 106 & TankNum != 107) 
finday <- rbind(fday, fday1)



endday <- dat %>% filter(ExptDay == 40 | ExptDay == 39 | ExptDay == 38 | ExptDay == 37)
endday1 <- dat %>% filter(ExptDay == 36) %>% filter(TankNum !=20 & TankNum !=21 & TankNum !=22 & TankNum != 23 &
                                                  TankNum !=24 & TankNum !=25 & TankNum !=26 & TankNum != 27 & 
                                                  TankNum !=28 & TankNum !=29 & TankNum !=30 & TankNum != 31 & 
                                                  TankNum !=32 & TankNum !=33 & TankNum !=34 & TankNum != 35 & 
                                                  TankNum !=36 & TankNum !=37 & TankNum !=38 & TankNum != 39 & 
                                                  TankNum !=40 & TankNum !=83 & TankNum !=84 & TankNum != 85 & 
                                                  TankNum !=86 & TankNum !=87 & TankNum !=88 & TankNum != 89 & 
                                                  TankNum !=90 & TankNum !=91 & TankNum !=92 & TankNum != 93 &
                                                  TankNum !=94 & TankNum !=95 & TankNum !=96 & TankNum != 97 & 
                                                  TankNum !=98 & TankNum !=99 & TankNum !=100& TankNum != 101 & 
                                                  TankNum != 102 & TankNum != 103 & TankNum != 104 & TankNum != 105 & 
                                                  TankNum != 106 & TankNum != 107)

end <- rbind(endday, endday1)

mean_nh4 <- finday %>% filter(treatment == 1) %>% summarize(avg = mean(NH4))
mean_chl <- finday %>% filter(treatment == 1) %>% summarize(avg = mean(Chl))
ggplot(data = end, aes(as.factor(treatment), Chl)) + geom_boxplot()
ggplot(data = end, aes(as.factor(treatment), Chl/mean_chl$avg)) + geom_boxplot()

ggplot(data=finday, aes(as.factor(treatment), NH4/mean_nh4$avg)) + geom_boxplot()
```


 
```{r algal resilience}

dat1 <- end %>% filter(disturb == "y")


## Put the order of the factors in a more reasonable order
dat1$animal <- factor(dat1$animal, levels = c("none", "snail", "daphnia", "both"))



inverse_cont <- matrix(nrow = 4, ncol = 4
  , data = c(
    1  ,  -1,      0,    0   ## snail vs none
  , 1  ,   0,     -1,    0   ## daphnia vs none
  , 0  ,    1,    -1,    0   ## difference between snails and daphnia
  , 0  ,  1/2,   1/2,   -1   ## synergistic effect of both animals vs avg of daph and snails.  
  )
  , byrow = TRUE)



dimnames(inverse_cont) <- list(

  c( ": snail",": daphnia", ": s vs d", ": both")
  ,   levels(dat1$animal)
)

## attempt to invert contrast matrix: doesn't work because we have
##  linearly dependent contrasts (sums of columns 1-3 == column 4)
try(cont <- solve(inverse_cont))

## fit model with one parameter per treatment
##   1. throw away non-positive values
##   2. set to some small value e.g. thresh <- 0.002
##      Chl[Chl<thresh] <- 0.001
##   3. censoring? (AER::tobit())
finmod0 <- lm(log10(Chl) ~ -1 + animal, data = dat1)
m1 <- multcomp::glht(finmod0,inverse_cont)
(s <- summary(m1))
plot(m1)
## broom::tidy(m1) ##  sucks, unfortunately
coef(finmod0)  ## compare to coefficients
e1 <-  emmeans(finmod0, ~animal)

plot(e1)
## vignette("multcomp-examples",package="multcomp") ## p. 11

### Fit the model with contrasts
## (don't do this, we hadn't inverted the contrast matrix yet)
## finmod <- lm(log(Chl) ~ animal, data = dat1, contrasts = list(animal = cont[,-1]))


### Clearly did something...
coefplot(finmod)


plot(resid(finmod))
qqnorm(resid(finmod))
```


Max Chl - resistance

```{r}

## need dummy date variable for tq_mutate to work....



Date <- paste(dat$Month, dat$Day,dat$Year, sep = "-")


betterDates <- as.Date(Date,
  format = "%B-%d-%Y")

dates <- data.frame(Dates1 = Date,
                    Dates2 = betterDates)

p <- dates %>% filter(is.na(Dates2))
which(is.na(dates$Dates2))
dates[c(390,400,409,418,421,440),2] <- "2019-03-02"
dates[419,2] <- "2019-01-31"
dates[498,2] <- "2019-02-03"
dates[(which(is.na(dates$Dates2))), 2] <- "2019-03-01"

dat$Date <- dates$Dates2

dat <- dat %>% filter(!is.na(adj_chl))
dat_dist <- dat %>% filter(ExptDay >= ExptDay[which(dat$Disturbed=="y")]) ## only days after disturbance

chl_rollmean <- dat_dist %>% group_by(treatment) %>%
    tq_mutate(
        # tq_mutate args
        select     = adj_chl,
        mutate_fun = rollapply, 
        
        # rollapply args
        width      = 3,
        FUN        = mean,
        # mean args
        na.rm  = TRUE,
        # tq_mutate args
        col_rename = "mean_3"
    ) 


max_chl <- chl_rollmean %>% group_by(TankNum) %>% 
  select(TankNum,treatment,animal, disturb,mean_3) %>%
  filter(mean_3 == max(mean_3, na.rm = T)) %>% filter(disturb == "y")


maxmod <- lm(log(mean_3) ~ animal, data = max_chl, contrasts = list(animal = cont[,-1]))


```

```{r}
library(ggplot2)
ggplot(dat_dist,
       aes(x=ExptDay,adj_chl,
           colour=animal,
           shape=disturb))+geom_point()+
  scale_y_log10() +
  facet_wrap(~disturb)+
  geom_smooth(method="gam",formula=y~s(x,k=10,bs="cs"),
              method.args=list(method="REML"))+
  geom_line(aes(group=TankNum),alpha=0.1)
```

Could do this with GAMs: https://rpubs.com/bbolker/ratgrowthcurves

Algal resistance, compare slope over time after disturbance
```{r algal resistance}
dat_dist <- transform(dat_dist,ExptDay0 = ExptDay-min(ExptDay,na.rm=TRUE))
library(lmerTest)
mod_res <- lmer(log10(adj_chl) ~ animal*ExptDay0 + (1|TankNum),
                data = dat_dist,
                subset=(disturb=="y" & ExptDay0<=5))
summary(mod_res)
plot(resid(mod_res))
qqnorm(resid(mod_res))
## rbind(
##  cbind(inverse_cont,matrix(0,4,4)),
##  cbind(matrix(0,4,4),inverse_cont)
## )
```

Graph algae
```{r graph algae, echo=FALSE}
s <- summary(mod2)
coef_dat <- s$coefficients
coef_dat2 <- data.frame(
  coefficients = row.names(coef_dat),
  estimate = coef_dat[,1],
  std_error = coef_dat[,2]
)
```

NH4 resilience, final time point
```{r algal resilience}

```


NH4 resistance, compare slope over time after disturbance
```{r algal resistance}

```

Graph NH4
```{r graph algae, echo=FALSE}

```

