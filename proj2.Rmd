---
title: "Group_project"
author: "Jo"
date: "October 28, 2019"
output: html_document
---

read in data add in treatment numbers
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("fix_chl.R")
source("Graphing_Set_Up.R")
library(lme4)
library(coefplot)
library(nlme)
library(tidyquant)
library(emmeans)
library(multcomp)
library(lmerTest)
library(gridExtra)
library(sjstats)
```


Remove treatments with ceriodaphnia since they didn't survive
```{r}
dat <- newdat %>% filter(! treatment %in% c(5,6,9,10,13,14))
```

make a columns for disturbed/undisturbed and both/none/cladoceran/snail

```{r}
dat$disturb <- "X"
  
for (i in 1:nrow(dat)){
  if (dat$treatment[i] ==2| dat$treatment[i] ==4| dat$treatment[i] ==8|
      dat$treatment[i] ==12){
    dat$disturb[i] <- "y"
  } else if (dat$treatment[i] ==1|dat$treatment[i] ==3|dat$treatment[i] ==7|dat$treatment[i] ==11){
    dat$disturb[i] <- "n"
  }}

dat$animal <- "X"

for (i in 1:nrow(dat)){
  if (dat$treatment[i] ==3| dat$treatment[i] ==4){
    dat$animal[i] <- "daphnia"
  } else if (dat$treatment[i] ==7|dat$treatment[i] ==8){
    dat$animal[i] <- "snail"
  } else if (dat$treatment[i] ==11|dat$treatment[i] ==12){
    dat$animal[i] <- "both"}
  else if (dat$treatment[i] ==1|dat$treatment[i] ==2){
    dat$animal[i] <- "none"}
}




df <- dat %>% filter(disturb == "y")

 
df <- df %>% group_by(animal, ExptDay) %>% summarize(avg = mean(NH4, na.rm = T), sd = sd(NH4, na.rm = T)) 

ggplot(data = df[df$ExptDay < 22,], aes(ExptDay, avg, color = animal)) + geom_point() + geom_errorbar(aes(ymin= avg-sd, ymax = avg+sd)) 

```



```{r, dates}

## need dummy date variable for tq_mutate to work.... and for random effect of experimental block

Date <- paste(dat$Month, dat$Day,dat$Year, sep = "-")


betterDates <- as.Date(Date,
  format = "%B-%d-%Y")

dates <- data.frame(Dates1 = Date,
                    Dates2 = betterDates)

p <- dates %>% filter(is.na(Dates2))
which(is.na(dates$Dates2))
dates[c(390,400,409,418,421,440),2] <- "2019-03-02"
dates[419,2] <- "2019-01-31"
dates[498,2] <- "2019-02-03"
dates[(which(is.na(dates$Dates2))), 2] <- "2019-03-01"

dat$Date <- dates$Dates2

## add blocking variable
block <- dat %>% filter(ExptDay == 1) %>% dplyr::select(Date, ExptDay, TankNum)
block$block <- NA
for (i in 1:nrow(block)){
  if (block$Date[i] == "2019-01-21" ) {
    block$block[i] <- "A"
  } else if (block$Date[i] == "2019-02-21" ) {
     block$block[i] <- "B"
  } else if (block$Date[i] == "2019-01-22" ) {
     block$block[i] <- "C"
  } else if (block$Date[i] == "2019-01-25" ) {
     block$block[i] <- "D"
  } else if (block$Date[i] == "2019-03-02" ) {
     block$block[i] <- "E"
  } else if (block$Date[i] == "2019-01-28" ) {
     block$block[i] <- "F"  
  } else if (block$Date[i] == "2019-01-30" ) {
     block$block[i] <- "G"  
  } else if (block$Date[i] == "2019-03-01" ) {
     block$block[i] <- "H"   
  } else if (block$Date[i] == "2019-02-02" ) {
     block$block[i] <- "I" 
  } else if (block$Date[i] == "2019-02-04" ) {
     block$block[i] <- "J"  
  } else if (block$Date[i] == "2019-02-05" ) {
     block$block[i] <- "K"   
  } 
}

block <- block %>% dplyr::select(TankNum, block)
dat <- left_join(dat,block, by = "TankNum")

```

Subset final time point for Nh4 and final 4 days for Chl
```{r final time point}
fday <- dat %>% filter(ExptDay == 40)
l <- as.numeric(unique(fday$TankNum))
fday1 <- dat %>% filter(ExptDay == 39) %>% filter(TankNum !=20 & TankNum !=21 & TankNum !=22 & TankNum != 23 &
                                                  TankNum !=24 & TankNum !=25 & TankNum !=26 & TankNum != 27 & 
                                                  TankNum !=28 & TankNum !=29 & TankNum !=30 & TankNum != 31 & 
                                                  TankNum !=32 & TankNum !=33 & TankNum !=34 & TankNum != 35 & 
                                                  TankNum !=36 & TankNum !=37 & TankNum !=38 & TankNum != 39 & 
                                                  TankNum !=40 & TankNum !=83 & TankNum !=84 & TankNum != 85 & 
                                                  TankNum !=86 & TankNum !=87 & TankNum !=88 & TankNum != 89 & 
                                                  TankNum !=90 & TankNum !=91 & TankNum !=92 & TankNum != 93 &
                                                  TankNum !=94 & TankNum !=95 & TankNum !=96 & TankNum != 97 & 
                                                  TankNum !=98 & TankNum !=99 & TankNum !=100& TankNum != 101 & 
                                                  TankNum != 102 & TankNum != 103 & TankNum != 104 & TankNum != 105 & 
                                                  TankNum != 106 & TankNum != 107) 
finday <- rbind(fday, fday1)



endday <- dat %>% filter(ExptDay == 40 | ExptDay == 39 | ExptDay == 38 | ExptDay == 37)
endday1 <- dat %>% filter(ExptDay == 36) %>% filter(TankNum !=20 & TankNum !=21 & TankNum !=22 & TankNum != 23 &
                                                  TankNum !=24 & TankNum !=25 & TankNum !=26 & TankNum != 27 & 
                                                  TankNum !=28 & TankNum !=29 & TankNum !=30 & TankNum != 31 & 
                                                  TankNum !=32 & TankNum !=33 & TankNum !=34 & TankNum != 35 & 
                                                  TankNum !=36 & TankNum !=37 & TankNum !=38 & TankNum != 39 & 
                                                  TankNum !=40 & TankNum !=83 & TankNum !=84 & TankNum != 85 & 
                                                  TankNum !=86 & TankNum !=87 & TankNum !=88 & TankNum != 89 & 
                                                  TankNum !=90 & TankNum !=91 & TankNum !=92 & TankNum != 93 &
                                                  TankNum !=94 & TankNum !=95 & TankNum !=96 & TankNum != 97 & 
                                                  TankNum !=98 & TankNum !=99 & TankNum !=100& TankNum != 101 & 
                                                  TankNum != 102 & TankNum != 103 & TankNum != 104 & TankNum != 105 & 
                                                  TankNum != 106 & TankNum != 107)

end <- rbind(endday, endday1)

mean_nh4 <- finday %>% filter(treatment == 1) %>% summarize(avg = mean(NH4))
mean_chl <- finday %>% filter(treatment == 1) %>% summarize(avg = mean(Chl))

chl_final <- ggplot(data = end, aes(animal, adj_chl, color = disturb)) + geom_boxplot()+ ylab("Final Chlorophyll a (ug/L)") + 
  xlab("Herbivore Treatment")+ theme(axis.line = element_line(colour = "black"), panel.border = element_blank()) + ggtitle("A.") + scale_color_manual(values = c("black", "seashell4")) + labs(color = "Disturbance")

nh4_final <- ggplot(data = finday, aes(animal, NH4, color = disturb)) + geom_boxplot()+ ylab("Final Nh4 concentration (mg/L)") + 
  xlab("Herbivore Treatment")+ theme(axis.line = element_line(colour = "black"), panel.border = element_blank()) + ggtitle("C.") + scale_color_manual(values = c("black", "seashell4")) + labs(color = "Disturbance")



```


 
```{r chl final}

dat1 <- end %>% filter(disturb == "y")


## Put the order of the factors in a more reasonable order
dat1$animal <- factor(dat1$animal, levels = c("none", "snail", "daphnia", "both"))

```

```{r contrast set up 1}
inverse_cont <- matrix(nrow = 4, ncol = 4
  , data = c(
    1  ,  -1,      0,    0   ## snail vs none
  , 1  ,   0,     -1,    0   ## daphnia vs none
  , 0  ,    1,    -1,    0   ## difference between snails and daphnia
  , 0  ,  1/2,   1/2,   -1   ## synergistic effect of both animals vs avg of daph and snails.  
  )
  , byrow = TRUE)



dimnames(inverse_cont) <- list(

  c( ": snail_vs_none",": daphnia_vs_none", ": s vs d", ": both")
  ,   levels(dat1$animal)
)

## attempt to invert contrast matrix: doesn't work because we have
##  linearly dependent contrasts (sums of columns 1-3 == column 4)
#try(cont <- solve(inverse_cont))

## fit model with one parameter per treatment
##   1. throw away non-positive values
##   2. set to some small value e.g. thresh <- 0.002
##      Chl[Chl<thresh] <- 0.001
##   3. censoring? (AER::tobit())

## it is only 2 points that are less than 0 so dropping them seems reasonable-- and 2 NAs that need to 
## be checked with data sheets

```




```{r chl final model}
dat1 <- dat1 %>% filter(!is.na(adj_chl))


## no adjustment for negative values
finmod0 <- lm(log10(adj_chl) ~ -1 + animal, data = dat1)
finmodsq <- lm(sqrt(adj_chl) ~ -1 + animal, data = dat1)

#drop negative values
finmod00 <- lmer(log10(adj_chl) ~ -1 + animal + (1|block), data = dat1[dat1$adj_chl > 0, ])
finmod00sq <- lm(sqrt(adj_chl) ~ -1 + animal, data = dat1[dat1$adj_chl > 0, ])

# set threshhold
#dat1[dat1$adj_chl < 0.001,] <- 0.1
#finmodth <- lm(log10(adj_chl) ~ -1 + animal, data = dat1)

## two options look identical

m1 <- multcomp::glht(finmod00,inverse_cont)

## perc diff between treatments
perc_diff <- function(a) {
  ((10^a)-1)*100
}


performance::r2(finmod00)
perc_diff(confint(m1)$confint)
(confint(m1)$confint)
(s <- summary(m1))
plot(m1)
## broom::tidy(m1) ##  sucks, unfortunately
coef(finmod00)  ## compare to coefficients
e1 <-  emmeans(finmod00, ~animal, type = "response")

plot(e1)
## vignette("multcomp-examples",package="multcomp") ## p. 11

### Fit the model with contrasts
## (don't do this, we hadn't inverted the contrast matrix yet)
## finmod <- lm(log(Chl) ~ animal, data = dat1, contrasts = list(animal = cont[,-1]))


plot(resid(finmod00))
qqnorm(resid(finmod00))
qqline(resid(finmod00),col=2) ## left-skewed
hist(resid(finmod00),col="gray")
## ?? consider sqrt() rather than log-transform?

plot(resid(finmod00sq))
qqnorm(resid(finmod00sq))
qqline(resid(finmod00sq),col=2) ## still left skewed but  a little more even?? 
hist(resid(finmod00sq),col="gray")

```

```{r plot chl end}
grdat1 <- data.frame(e1)

gg <- ggplot(data = grdat1, aes(animal, response)) + geom_point(size = 3) + 
  geom_errorbar(aes(ymin=lower.CL, ymax = upper.CL), width = 0.3) + ylab("Final Chl a (ug/L)") + 
  xlab(" ")+ theme(axis.line = element_line(colour = "black"), panel.border = element_blank()) + ggtitle("A.")

```


Max Chl - 

```{r max chl}


dat <- dat %>% filter(!is.na(adj_chl))
dat_dist <- dat %>% filter(ExptDay >= ExptDay[which(dat$Disturbed=="y")]) ## only days after disturbance

chl_rollmean <- dat_dist %>% group_by(treatment) %>%
    tq_mutate(
        # tq_mutate args
        select     = adj_chl,
        mutate_fun = rollapply, 
        
        # rollapply args
        width      = 3,
        FUN        = mean,
        # mean args
        na.rm  = TRUE,
        # tq_mutate args
        col_rename = "mean_3"
    )   %>%
 ungroup()


max_chl <- chl_rollmean %>% group_by(TankNum) %>% 
  dplyr::select(TankNum,treatment,animal, disturb,mean_3, block) %>%
  filter(mean_3 == max(mean_3, na.rm = T))

max_chl_g <- ggplot(data = max_chl, aes(animal, mean_3, color = disturb)) + geom_boxplot()+ ylab("Maximum Chlorophyll a (ug/L)") + 
  xlab("Herbivore Treatment")+ theme(axis.line = element_line(colour = "black"), panel.border = element_blank()) + ggtitle("B.") + scale_color_manual(values = c("black", "seashell4")) + labs(color = "Disturbance")

max_chl <- max_chl %>% filter(disturb == "y")

max_chl$animal <- as.factor(max_chl$animal)
## Put the order of the factors in a more reasonable order
max_chl$animal <- factor(max_chl$animal, levels = c("none", "snail", "daphnia", "both"))

maxmod <- lmer(log10(mean_3) ~ -1+animal + (1|block), data = max_chl)

performance::r2(maxmod)
plot(resid(maxmod)) ##hmm definitely seems like a pattern but there aren't that many points
plot.new()
qqnorm(resid(maxmod))
qqline(resid(maxmod),col=2) ## also left skewed but not terrible?
hist(resid(maxmod),col="gray")
mm <- multcomp::glht(maxmod,inverse_cont)
(ss <- summary(mm))
(confint(mm)$confint)


plot(mm)

perc_diff(confint(mm)$confint)

coef(maxmod)  ## compare to coefficients
e2 <-  emmeans(maxmod, ~animal, type = "response")

plot(e2)



```

```{r plot max chl}
grdat2 <- data.frame(e2)

g1 <- ggplot(data = grdat2, aes(animal, response)) + geom_point(size = 3) + 
  geom_errorbar(aes(ymin=lower.CL, ymax = upper.CL), width = 0.3) + ylab("Maximum Chl a (ug/L)") + 
  xlab(" ")+ theme(axis.line = element_line(colour = "black"), panel.border = element_blank()) + ggtitle("B.")

```


NH4 resilience, final time point
```{r ammonium final}
finday1 <- finday %>% filter(disturb == "y")
finday1$animal <- factor(finday1$animal,levels = c("none", "snail", "daphnia", "both")) 
amm_end <- lmer(data = finday1, log10(NH4) ~ -1+ animal + (1|block))
plot(resid(amm_end))
qqnorm(resid(amm_end))
performance::r2(amm_end)

amm1 <- multcomp::glht(amm_end,inverse_cont)
(samm <- summary(amm1))
plot(amm1)
e1_amm <-  emmeans(amm_end, ~animal,type = "response" )

perc_diff(confint(amm1)$confint)

plot(e1_amm)

```

```{r plot final ammonium}
grdat3 <- data.frame(e1_amm)

g2 <- ggplot(data = grdat3, aes(animal, response)) + geom_point(size = 3) + 
  geom_errorbar(aes(ymin=lower.CL, ymax = upper.CL), width = 0.3) + ylab("Final NH4-N (mg/L)") + 
  xlab("Herbivore Treatment")+ theme(axis.line = element_line(colour = "black"), panel.border = element_blank()) + ggtitle("C.")

```


max Nh4 post disturbance
```{r ammonium max}

nh_max1 <- dat_dist %>% group_by(TankNum) %>% mutate(max_nh4= max(NH4,na.rm = T))%>% ungroup()
max_nh4_g <- ggplot(data = nh_max1, aes(animal, max_nh4, color = disturb)) + geom_boxplot()+ ylab("Maximum NH4 (mg/L)") + 
  xlab("Herbivore Treatment")+ theme(axis.line = element_line(colour = "black"), panel.border = element_blank()) + ggtitle("B.") + scale_color_manual(values = c("black", "seashell4")) + labs(color = "Disturbance")

nh_max1$animal <- factor(nh_max1$animal, levels = c("none", "snail", "daphnia", "both"))

nh4_max2 <- nh_max1 %>% filter(disturb == "y")
nh4_max_mod <- lmer(log10(max_nh4) ~ -1+animal + (1|block), data = nh4_max2)

performance::r2(nh4_max_mod)

plot(resid(nh4_max_mod))
qqnorm(resid(nh4_max_mod)) #hmm




amm_max <- multcomp::glht(nh4_max_mod,inverse_cont)
(smax <- summary(amm_max))
perc_diff(confint(amm_max)$confint)
plot(amm_max)
e1_max <-  emmeans(nh4_max_mod, ~animal, type = "response")


plot(e1_max)



```


```{r plot max nh4}
grdat4 <- data.frame(e1_max)

g3 <- ggplot(data = grdat4, aes(animal, response)) + geom_point(size = 3) + 
  geom_errorbar(aes(ymin=lower.CL, ymax = upper.CL), width = 0.3) + ylab("Maximum NH4-N (mg/L)") + 
  xlab("Herbivore Treatment")+ theme(axis.line = element_line(colour = "black"), panel.border = element_blank()) + ggtitle("D.")


grid.arrange(gg, g1,g2, g3, nrow =2)

```



```{r sediment data}
sed <- read.csv("sediment.csv")
newdat1 <- newdat %>%filter(ExptDay == 1)%>% dplyr::select(TankNum, treatment)
sed1 <- left_join(newdat1, sed)
sed1 <- left_join(sed1,block, by= "TankNum")
sed2 <- sed1 %>% filter(! treatment %in% c(5,6,9,10,13,14))
dat2 <- dat %>% filter(ExptDay==1)%>%dplyr::select(treatment, disturb, animal, TankNum)
sed3 <- left_join(dat2,sed2)
sed3$animal <- factor(sed3$animal,levels = c("none", "snail", "daphnia", "both"))

ggplot(data = sed3, aes(as.factor(treatment), sediment)) + geom_boxplot()
```


```{r sediment model}

sedmod <- lmer(log10(sediment) ~ -1+ animal + (1|block),data = sed3, subset=(disturb=="y") ) ## hmm do all my models need random effect of tank??-- i only have 2 measurement per tank...so that doesn't seem doable but should i do something? 



plot(resid(sedmod))
qqnorm(resid(sedmod)) 
qqline(resid(sedmod),col=2) 
hist(resid(sedmod),col="gray")

sedmulti <- multcomp::glht(sedmod,inverse_cont)
(sed_summ <- summary(sedmulti))
plot(sedmulti)
e1_sed <-  emmeans(sedmod, ~animal,type = "response" )

plot(e1_sed)

perc_diff(confint(sedmulti)$confint)

```
```{r plot sediment}
grdat5 <- data.frame(e1_sed)

g3 <- ggplot(data = grdat5, aes(animal, response)) + geom_point(size = 3) + 
  geom_errorbar(aes(ymin=lower.CL, ymax = upper.CL), width = 0.3) + ylab("Sediment (mL)") + 
  xlab("Herbivore Treatment")+ theme(axis.line = element_line(colour = "black"), panel.border = element_blank())

```


egg casing
```{r daphnia egg cases}
egg <- read.csv("egg_case.csv")
names(egg) <- c("TankNum","eggs")
egg1 <- left_join(newdat1, egg)
egg1 <- left_join(egg1,block, by= "TankNum")
egg2 <- egg1 %>% filter(! treatment %in% c(5,6,9,10,13,14))
egg3 <- left_join(dat2,egg2)
egg3$animal <- factor(egg3$animal,levels = c("none", "snail", "daphnia", "both"))
egg4 <- egg3 %>% filter(animal %in% c("both","daphnia"))
```

```{r egg case model}
eggmod <- glmer(eggs~-1+animal*disturb + (1|block), family = binomial(link= logit), data = egg4)
## estimate main effects at midpoint by using sum-to-zero contrasts
## (probably better)
eggmod_cs <- update(eggmod, contrasts=list(animal=contr.sum,disturb=contr.sum))

## check for overdispersion based on https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html
overdisp_fun <- function(model) {
    rdf <- df.residual(model)
    rp <- residuals(model,type="pearson")
    Pearson.chisq <- sum(rp^2)
    prat <- Pearson.chisq/rdf
    pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
    c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}

overdisp_fun(eggmod)  ## very underdispersed
egg4$eggs <- as.numeric(egg4$eggs)

eggmod2 <- glmer.nb(eggs~-1+animal*disturb + (1|block), family = quasibinomial(link = "logit"), data = egg4) ## should be beta-binomial??

```


```{r plot_eggcases}
## 1. this is probably the best representation
plot(emmeans(eggmod,~animal*disturb),type="response")
## if you want to plot this yourself:
dd <- as.data.frame(emmeans(eggmod,~animal*disturb),type="response")
## or plot the coefficients (probably not what you want)
##dotwhisker::dwplot(eggmod)+geom_vline(xintercept=0,lty=2)
dd$treat <- paste(dd$animal,dd$disturb)

eggg <- ggplot(data = dd, aes(treat, prob)) + geom_point(aes(color = disturb, shape = animal), size = 3) + geom_errorbar(aes(ymin= asymp.LCL, ymax=asymp.UCL, color= disturb), width = 0.3)+ ylab("Probablity Ephippium Present") + 
  xlab("Herbivore Treatment")+ theme(axis.line = element_line(colour = "black"), panel.border = element_blank()) + scale_color_manual(values = c("black", "seashell4")) + 
    labs(color="Disturbance", shape = "Herbivore") 
```

daphnia populations
```{r daphnia populations}
pop1 <- pop %>% filter(! treatment %in% c(5,6,9,10,13,14))
pop1$disturb <- "X"
  
for (i in 1:nrow(pop1)){
  if (pop1$treatment[i] ==2| pop1$treatment[i] ==4| pop1$treatment[i] ==8|
      pop1$treatment[i] ==12){
    pop1$disturb[i] <- "y"
  } else if (pop1$treatment[i] ==1|pop1$treatment[i] ==3|pop1$treatment[i] ==7|pop1$treatment[i] ==11){
    pop1$disturb[i] <- "n"
  }}

pop1$animal <- "X"

for (i in 1:nrow(pop1)){
  if (pop1$treatment[i] ==3| pop1$treatment[i] ==4){
    pop1$animal[i] <- "daphnia"
  } else if (pop1$treatment[i] ==7|pop1$treatment[i] ==8){
    pop1$animal[i] <- "snail"
  } else if (pop1$treatment[i] ==11|pop1$treatment[i] ==12){
    pop1$animal[i] <- "both"}
  else if (pop1$treatment[i] ==1|pop1$treatment[i] ==2){
    pop1$animal[i] <- "none"}
}

popA <- pop1 %>% dplyr::select(TankNum, treatment,animal, disturb, Exptday, daphniaC1Adult,daphniaC2Adult,daphniaC3,
                       daphniaC4Adult,Liters, daphniaC1Juv,daphniaC2Juv,daphniaC3Juv,
                       daphniaC4Juv)
popA <- popA %>% gather(key = "subsample", value= "count", -c(TankNum,treatment, Exptday, Liters, animal, disturb))

popB <- popA %>% separate(subsample, into=c("daphnia","subsample","stage"),sep ='([[:upper:]])', extra = "drop", fill = "right" )


popB <- popB %>% group_by(TankNum, Exptday, subsample, animal, disturb) %>% 
  summarize(total = sum(count))
popB <- left_join(popB, block, by= "TankNum")

```

Final Population
```{r daphnia final pop}
pop_fin <- popB %>% group_by(TankNum) %>% filter(Exptday == max(Exptday))

pop_fin$treat <- paste(pop_fin$animal,pop_fin$disturb)

## desired contrasts 
## bothY vs bothN,
## daphnia Y vs Daphnia N
## daphnia Y vs both Y

pop_fin$treat <- factor(pop_fin$treat, levels = c("daphnia n", "both n", "daphnia y", "both y"))
inverse_contp <- matrix(nrow = 3, ncol = 4
  , data = c(
    1  ,   0,     -1,    0   ## daphnia n vs daphnia y
  , 0  ,   1,     0,    -1    ## both n vs both y
  , 0  ,   1,    -1,    0     ## both y vs daphnia y
  )
  , byrow = TRUE)



dimnames(inverse_contp) <- list(

  c( "daphn_vs_daphy","bothn_vs_bothy", "bothy_vs_daphy")
  ,   levels(pop_fin$treat)
)



daph_fin_mod <- glmer(total ~ -1 + treat + (1|TankNum) + (1|block),data = pop_fin, family = "poisson" ) ## do i need to add th e block I think so....
plot(resid(daph_fin_mod))
qqnorm(resid(daph_fin_mod))

pp <- multcomp::glht(daph_fin_mod,inverse_contp)
summary(pp)

e1_pop <-  emmeans(daph_fin_mod, ~treat, type = "response")

plot(e1_pop)


```

```{r plot final pop}
popgd <- data.frame(e1_pop)
popgd <- popgd %>% separate(treat,into=c("animal","disturb"),sep =' ' )
popgd$treat <- paste(popgd$animal,popgd$disturb)

popg <- ggplot(data = popgd, aes(treat,rate)) +  
   geom_point(aes(color = disturb, shape = animal), size = 3) + geom_errorbar(aes(ymin= asymp.LCL, ymax=asymp.UCL, color= disturb), width = 0.3)+ ylab("Daphnia magna per 10mL") + 
  xlab(" ")+ theme(axis.line = element_line(colour = "black"), panel.border = element_blank()) + scale_color_manual(values = c("black", "seashell4")) + ggtitle("A. Final Population")+ theme(legend.position = "none") 

```


Max population- post disturbance
```{r daphnia max}
dd <- dat_dist %>% filter(! treatment %in% c(5,6,9,10,13,14))%>% filter(animal %in% c("both","daphnia")) %>% dplyr::select(TankNum, ExptDay) %>%
  group_by(TankNum) %>% filter(ExptDay == min(ExptDay))  
names(dd) <- c("TankNum", "E1")
dd1 <- left_join(popB,dd, by= "TankNum")
daph_dist <- dd1 %>% filter(Exptday >= E1)
daph_avg_pop <- daph_dist %>% group_by(TankNum, Exptday) %>% 
  mutate(pop = mean(total, na.rm= TRUE), sdpop= sd(total, na.rm = T))
daph_max <- daph_avg_pop %>% group_by(TankNum) %>% filter(pop == max(pop))

daph_max$treat <- paste(daph_max$animal, daph_max$disturb)

daph_max_mod <- lm(log(pop) ~ treat, data = daph_max, weights = sdpop)

plot(resid(daph_max_mod))
qqnorm(resid(daph_max_mod))




```


```{r contrasts pop max}
pm <- multcomp::glht(daph_max_mod,inverse_contp) ## something about my contrasts is wrong
summary(pm)

e2_pop <-  emmeans(daph_max_mod, ~treat, type = "response")

popmg <- data.frame(e2_pop)
popmg <- popmg %>% separate(treat,into=c("animal","disturb"),sep =' ' )
popmg$treat <- paste(popmg$animal,popmg$disturb)

popg_max <- ggplot(data = popmg, aes(treat,response)) +  
   geom_point(aes(color = disturb, shape = animal), size = 3) + geom_errorbar(aes(ymin= lower.CL, ymax=upper.CL, color= disturb), width = 0.3)+ ylab("Daphnia magna per 10 mL ") + 
  xlab("Herbivore Treatment")+ theme(axis.line = element_line(colour = "black"), panel.border = element_blank()) + scale_color_manual(values = c("black", "seashell4")) + ggtitle("B. Maximum population") + labs(color = "Disturbance", shape = "Herbivore") + theme(legend.position = c(0.85,0.25), legend.box = "horizontal", legend.background = element_rect(fill = "transparent"))

grid.arrange(popg, popg_max, nrow = 2)

```




